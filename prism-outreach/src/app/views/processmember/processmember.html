
<main id="main" class="main" style="margin-top:50px!important;min-height:550px;">
    <section class="section dashboard">
        <div class="row">
         <!-- Left side columns -->
         <div class="col-lg-12">
           <div class="card">
                     <div class="card-body">

                         <div class="row align-items-center">
                            <!-- Upload form -->
                        <div class="col-lg-6">
                    <form [formGroup]="processMembersFormGroup" (ngSubmit)="membersFileSubmit()" enctype="multipart/form-data">
                        <div class="row g-2 align-items-center">
                            <div class="col-lg-4 text-uppercase">
                            Select Member File
                            </div>

                            <div class="col-lg-4 ">
                            <input
                                type="file"
                                formControlName="file"
                                (change)="onFileSelect($event)"
                                accept=".csv"
                                class="form-control"
                                required
                            />
                            <div class="text-danger mt-1" *ngIf="processMembersFormGroup.invalid && (processMembersFormGroup.dirty || processMembersFormGroup.touched)">
                                File is required.
                            </div>
                            </div>

                            <div class="col-lg-4 text-uppercase">
                            <button
                            type="submit"
                            class="btn btn-primary w-100 text-uppercase"
                            [disabled]="isUpload || !processMembersFormGroup.valid"
                            >
                            @if (isUpload) {
                                <span class="spinner-border spinner-border-sm me-2"></span> Uploading...
                            } @else {
                                Upload
                            }
                            </button>
                            </div>
                        </div>
                        </form>

                    </div>
    
                    <!-- <div class="col-lg-6  text-uppercase">
                        <a href="/sample_file/Member_sample_file.csv" target="_blank">MEMBER SAMPLE FILE</a>
                    </div> -->

                    <!-- ✅ Show if we have uploaded temp members -->
                    @if (totalRecords > 0) {
                        <!-- Member info -->
                        <div class="col-lg-3 text-uppercase">
                        <div>Total members: {{ totalRecords }}</div>

                        @if (error_count > 0) {
                            <div class="text-danger">
                            Error record(s): {{ error_count }}
                            </div>
                        }

                        @if (exist_count > 0) {
                            <div class="text-warning">
                            Existing members: {{ exist_count }}
                            </div>
                        }
                        </div>

                        <!-- Process button -->
                        <div class="col-lg-2">
                        <button
                            type="button"
                            class="btn btn-success w-100 text-uppercase"
                            (click)="processMembers()"
                            [disabled]="isProcessing"
                        >
                        @if (isProcessing) {
                            <span class="spinner-border spinner-border-sm me-2"></span> Processing...
                        } @else {
                            Process
                        }
                        </button>
                        </div>
                    } @else {
                        <!-- Sample file link -->
                        <div class="col-lg-6 text-uppercase">
                        <a href="/sample_file/Member_sample_file.csv" target="_blank">
                            MEMBER SAMPLE FILE
                        </a>
                        </div>
                    }
    
                    <!-- Messages -->
                    <div class="col-lg-6">
                        
                    </div>
                </div>


            </div>
           </div>
         </div>
        </div>
<!-- ✅ Show table only if there are temp members -->
<div class="row" *ngIf="tempMemberList && tempMemberList.length > 0">
  <div class="col-lg-12">
    <div class="card">
      <div class="card-body">

        <table class="table table-sm table-borderless" id="tempMemberList">
          <thead>
            <tr>
              <th>SUBSCRIBER_ID</th>
              <th>FIRST_NM</th>
              <th>MIDDLE_NM</th>
              <th>LAST_NM</th>
              <th>MEDICARE_ID</th>
              <th>MEDICAID_ID</th>
              <th>DT_OF_BIRTH</th>
              <th>SEX</th>
              <th>HOME_TELEPHONE</th>
              <th>PCP_TAX_ID</th>
              <th>STATUS</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let member of tempMemberList">
              <td>{{ member.SUBSCRIBER_ID }}</td>
              <td>{{ member.FIRST_NM }}</td>
              <td>{{ member.MIDDLE_NM }}</td>
              <td>{{ member.LAST_NM }}</td>
              <td>{{ member.MEDICARE_ID }}</td>
              <td>{{ member.MEDICAID_ID }}</td>
              <td>{{ member.DT_OF_BIRTH | date: 'MM/dd/yyyy' }}</td>
              <td>{{ member.SEX }}</td>
              <td>{{ member.HOME_TELEPHONE }}</td>
              <td>{{ member.PCP_TAX_ID }}</td>

              <!-- ✅ Conditional background color for status -->
              <td
                [ngStyle]="{
                  'background-color': member.SUBSCRIBER_ID === null || member.SUBSCRIBER_ID === '' ? 'red' :
                                     member.exist_member ? 'yellow' : 'transparent'
                }"
              >
                <ng-container *ngIf="member.exist_member">
                  Member already exists
                </ng-container>
                <ng-container *ngIf="!member.exist_member && (!member.SUBSCRIBER_ID || member.SUBSCRIBER_ID.trim() === '')">
                  Subscriber ID is missing
                </ng-container>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- ✅ Optional Summary -->
        <!-- <div class="mt-3 text-uppercase fw-bold">
          Total Records: {{ totalRecords }} |
          Existing Members: {{ exist_count }} |
          Errors: {{ error_count }}
        </div> -->
      </div>
    </div>
  </div>
</div>
       
<!-- ✅ Show only if processLogList has items -->
@if (processLogList.length > 0) {
  <div class="row mt-4">
    <div class="col-lg-3"></div>

    <div class="col-lg-6">
      <div class="card shadow-sm rounded-3">
        <div class="card-body">
          <h3 class="text-uppercase mb-3 text-center">Member File Upload Process Details</h3>

          <table class="table table-sm table-borderless align-middle" id="tempMemberList1">
            <thead class="table-light">
              <tr>
                <th>PROCESS MESSAGE</th>
                <th>COUNT</th>
                <th>DATE / TIME</th>
              </tr>
            </thead>

            <tbody>
              @for (log of processLogList; track log) {
                <tr [ngStyle]="{ color: log.LOG_TYPE === 'Error' ? 'red' : 'inherit' }">
                  <td>{{ log.MESSAGE }}</td>
                  <td>{{ log.RECORD_COUNT || '' }}</td>
                  <td>{{ log.LOG_DATE | date: 'short' }}</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-lg-3"></div>
  </div>
}
       
    </section>
</main>